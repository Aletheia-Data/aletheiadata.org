"use strict";

var _interopRequireWildcard = require("@babel/runtime/helpers/interopRequireWildcard");

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.DEFAULT_STATE = void 0;

var _classCallCheck2 = _interopRequireDefault(require("@babel/runtime/helpers/classCallCheck"));

var _createClass2 = _interopRequireDefault(require("@babel/runtime/helpers/createClass"));

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _slicedToArray2 = _interopRequireDefault(require("@babel/runtime/helpers/slicedToArray"));

var _URLManager = _interopRequireDefault(require("./URLManager"));

var _RequestSequencer = _interopRequireDefault(require("./RequestSequencer"));

var _DebounceManager = _interopRequireDefault(require("./DebounceManager"));

var actions = _interopRequireWildcard(require("./actions"));

var _Events = _interopRequireDefault(require("./Events"));

var a11y = _interopRequireWildcard(require("./A11yNotifications"));

function ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); keys.push.apply(keys, symbols); } return keys; }

function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(Object(source), true).forEach(function (key) { (0, _defineProperty2.default)(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }

function filterSearchParameters(_ref) {
  var current = _ref.current,
      filters = _ref.filters,
      resultsPerPage = _ref.resultsPerPage,
      searchTerm = _ref.searchTerm,
      sortDirection = _ref.sortDirection,
      sortField = _ref.sortField;
  return {
    current: current,
    filters: filters,
    resultsPerPage: resultsPerPage,
    searchTerm: searchTerm,
    sortDirection: sortDirection,
    sortField: sortField
  };
}

var DEFAULT_STATE = {
  // Search Parameters -- This is state that represents the input state.
  current: 1,
  filters: [],
  resultsPerPage: 20,
  searchTerm: "",
  sortDirection: "",
  sortField: "",
  // Result State -- This state represents state that is updated automatically
  // as the result of changing input state.
  autocompletedResults: [],
  autocompletedResultsRequestId: "",
  autocompletedSuggestions: {},
  autocompletedSuggestionsRequestId: "",
  error: "",
  isLoading: false,
  facets: {},
  requestId: "",
  results: [],
  resultSearchTerm: "",
  totalPages: 0,
  totalResults: 0,
  pagingStart: 0,
  pagingEnd: 0,
  wasSearched: false
};
exports.DEFAULT_STATE = DEFAULT_STATE;

function removeConditionalFacets() {
  var facets = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {};
  var conditionalFacets = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {};
  var filters = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : [];
  return Object.entries(facets).reduce(function (acc, _ref2) {
    var _ref3 = (0, _slicedToArray2.default)(_ref2, 2),
        facetKey = _ref3[0],
        facet = _ref3[1];

    if (conditionalFacets[facetKey] && typeof conditionalFacets[facetKey] === "function" && !conditionalFacets[facetKey]({
      filters: filters
    })) {
      return acc;
    }

    acc[facetKey] = facet;
    return acc;
  }, {});
}
/*
 * The Driver is a framework agnostic search state manager that is capable
 * syncing state to the url.
 */


var SearchDriver = /*#__PURE__*/function () {
  function SearchDriver(_ref4) {
    var _this = this;

    var apiConnector = _ref4.apiConnector,
        _ref4$autocompleteQue = _ref4.autocompleteQuery,
        autocompleteQuery = _ref4$autocompleteQue === void 0 ? {} : _ref4$autocompleteQue,
        debug = _ref4.debug,
        initialState = _ref4.initialState,
        onSearch = _ref4.onSearch,
        onAutocomplete = _ref4.onAutocomplete,
        onResultClick = _ref4.onResultClick,
        onAutocompleteResultClick = _ref4.onAutocompleteResultClick,
        _ref4$searchQuery = _ref4.searchQuery,
        searchQuery = _ref4$searchQuery === void 0 ? {} : _ref4$searchQuery,
        _ref4$trackUrlState = _ref4.trackUrlState,
        trackUrlState = _ref4$trackUrlState === void 0 ? true : _ref4$trackUrlState,
        _ref4$urlPushDebounce = _ref4.urlPushDebounceLength,
        urlPushDebounceLength = _ref4$urlPushDebounce === void 0 ? 500 : _ref4$urlPushDebounce,
        _ref4$hasA11yNotifica = _ref4.hasA11yNotifications,
        hasA11yNotifications = _ref4$hasA11yNotifica === void 0 ? false : _ref4$hasA11yNotifica,
        _ref4$a11yNotificatio = _ref4.a11yNotificationMessages,
        a11yNotificationMessages = _ref4$a11yNotificatio === void 0 ? {} : _ref4$a11yNotificatio,
        _ref4$alwaysSearchOnI = _ref4.alwaysSearchOnInitialLoad,
        alwaysSearchOnInitialLoad = _ref4$alwaysSearchOnI === void 0 ? false : _ref4$alwaysSearchOnI;
    (0, _classCallCheck2.default)(this, SearchDriver);
    (0, _defineProperty2.default)(this, "state", DEFAULT_STATE);
    (0, _defineProperty2.default)(this, "_updateAutocomplete", function (searchTerm) {
      var _ref5 = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {},
          autocompleteResults = _ref5.autocompleteResults,
          autocompleteSuggestions = _ref5.autocompleteSuggestions;

      var requestId = _this.autocompleteRequestSequencer.next();

      var queryConfig = _objectSpread({}, autocompleteResults && {
        results: _this.autocompleteQuery.results || {}
      }, {}, autocompleteSuggestions && {
        suggestions: _this.autocompleteQuery.suggestions || {}
      });

      return _this.events.autocomplete({
        searchTerm: searchTerm
      }, queryConfig).then(function (autocompleted) {
        if (_this.autocompleteRequestSequencer.isOldRequest(requestId)) return;

        _this.autocompleteRequestSequencer.completed(requestId);

        _this._setState(autocompleted);
      });
    });
    (0, _defineProperty2.default)(this, "_updateSearchResults", function (searchParameters) {
      var _ref6 = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {},
          _ref6$skipPushToUrl = _ref6.skipPushToUrl,
          skipPushToUrl = _ref6$skipPushToUrl === void 0 ? false : _ref6$skipPushToUrl,
          _ref6$replaceUrl = _ref6.replaceUrl,
          replaceUrl = _ref6$replaceUrl === void 0 ? false : _ref6$replaceUrl;

      var _this$state$searchPar = _objectSpread({}, _this.state, {}, searchParameters),
          current = _this$state$searchPar.current,
          filters = _this$state$searchPar.filters,
          resultsPerPage = _this$state$searchPar.resultsPerPage,
          searchTerm = _this$state$searchPar.searchTerm,
          sortDirection = _this$state$searchPar.sortDirection,
          sortField = _this$state$searchPar.sortField; // State updates should always be applied in the order that they are made. This function, _updateSearchResults,
      // makes state updates.
      // In the case where a call to "_updateSearchResults" was made and delayed for X amount of time using
      // `debounceManager.runWithDebounce`, and a subsequent call is made _updateSearchResults before that delay ends, we
      // want to make sure that outstanding call to "_updateSearchResults" is cancelled, as it would apply state updates
      // out of order.


      _this.debounceManager.cancelByName("_updateSearchResults");

      _this._setState({
        current: current,
        error: "",
        filters: filters,
        resultsPerPage: resultsPerPage,
        searchTerm: searchTerm,
        sortDirection: sortDirection,
        sortField: sortField
      });

      _this._makeSearchRequest({
        skipPushToUrl: skipPushToUrl,
        replaceUrl: replaceUrl
      });
    });
    (0, _defineProperty2.default)(this, "_makeSearchRequest", _DebounceManager.default.debounce(0, function (_ref7) {
      var skipPushToUrl = _ref7.skipPushToUrl,
          replaceUrl = _ref7.replaceUrl;
      var _this$state = _this.state,
          current = _this$state.current,
          filters = _this$state.filters,
          resultsPerPage = _this$state.resultsPerPage,
          searchTerm = _this$state.searchTerm,
          sortDirection = _this$state.sortDirection,
          sortField = _this$state.sortField;

      _this._setState({
        isLoading: true
      });

      var requestId = _this.searchRequestSequencer.next();

      var queryConfig = _objectSpread({}, _this.searchQuery, {
        facets: removeConditionalFacets(_this.searchQuery.facets, _this.searchQuery.conditionalFacets, filters)
      });

      var requestState = filterSearchParameters(_this.state);
      return _this.events.search(requestState, queryConfig).then(function (resultState) {
        if (_this.searchRequestSequencer.isOldRequest(requestId)) return;

        _this.searchRequestSequencer.completed(requestId); // Results paging start & end


        var totalResults = resultState.totalResults;
        var start = totalResults === 0 ? 0 : (current - 1) * resultsPerPage + 1;
        var end = totalResults <= start + resultsPerPage ? totalResults : start + resultsPerPage - 1;

        _this._setState(_objectSpread({
          isLoading: false,
          resultSearchTerm: searchTerm,
          pagingStart: start,
          pagingEnd: end
        }, resultState, {
          wasSearched: true
        }));

        if (_this.hasA11yNotifications) {
          var messageArgs = {
            start: start,
            end: end,
            totalResults: totalResults,
            searchTerm: searchTerm
          };

          _this.actions.a11yNotify("searchResults", messageArgs);
        }

        if (!skipPushToUrl && _this.trackUrlState) {
          // We debounce here so that we don't get a lot of intermediary
          // URL state if someone is updating a UI really fast, like typing
          // in a live search box for instance.
          _this.debounceManager.runWithDebounce(_this.urlPushDebounceLength, "pushStateToURL", _this.URLManager.pushStateToURL.bind(_this.URLManager), {
            current: current,
            filters: filters,
            resultsPerPage: resultsPerPage,
            searchTerm: searchTerm,
            sortDirection: sortDirection,
            sortField: sortField
          }, {
            replaceUrl: replaceUrl
          });
        }
      }, function (error) {
        _this._setState({
          error: "An unexpected error occurred: ".concat(error.message)
        });
      });
    }));
    this.actions = Object.entries(actions).reduce(function (acc, _ref8) {
      var _ref9 = (0, _slicedToArray2.default)(_ref8, 2),
          actionName = _ref9[0],
          action = _ref9[1];

      return _objectSpread({}, acc, (0, _defineProperty2.default)({}, actionName, action.bind(_this)));
    }, {});
    Object.assign(this, this.actions);
    this.events = new _Events.default({
      apiConnector: apiConnector,
      onSearch: onSearch,
      onAutocomplete: onAutocomplete,
      onResultClick: onResultClick,
      onAutocompleteResultClick: onAutocompleteResultClick
    });
    this.debug = debug;

    if (this.debug) {
      console.warn("Search UI Debugging is enabled. This should be turned off in production deployments.");
      window.searchUI = this;
    }

    this.autocompleteRequestSequencer = new _RequestSequencer.default();
    this.searchRequestSequencer = new _RequestSequencer.default();
    this.debounceManager = new _DebounceManager.default();
    this.autocompleteQuery = autocompleteQuery;
    this.searchQuery = searchQuery;
    this.subscriptions = [];
    this.trackUrlState = trackUrlState;
    this.urlPushDebounceLength = urlPushDebounceLength;
    this.alwaysSearchOnInitialLoad = alwaysSearchOnInitialLoad;
    var urlState;

    if (trackUrlState) {
      this.URLManager = new _URLManager.default();
      urlState = this.URLManager.getStateFromURL();
      this.URLManager.onURLStateChange(function (urlState) {
        _this._updateSearchResults(_objectSpread({}, DEFAULT_STATE, {}, urlState), {
          skipPushToUrl: true
        });
      });
    } else {
      urlState = {};
    } // Manage screen reader accessible notifications


    this.hasA11yNotifications = hasA11yNotifications;
    if (this.hasA11yNotifications) a11y.getLiveRegion();
    this.a11yNotificationMessages = _objectSpread({}, a11y.defaultMessages, {}, a11yNotificationMessages); // Remember the state this application is initialized into, so that we can
    // reset to it later.

    this.startingState = _objectSpread({}, this.state, {}, initialState); // We filter these here to disallow anything other than valid search
    // parameters to be passed in initial state, or url state. `results`, etc,
    // should not be allowed to be passed in, that should be generated based on
    // the results of the query

    var _searchParameters = filterSearchParameters(_objectSpread({}, this.startingState, {}, urlState)); // Initialize the state without calling _setState, because we don't
    // want to trigger an update callback, we're just initializing the state
    // to the correct default values for the initial UI render


    this.state = _objectSpread({}, this.state, {}, _searchParameters); // We'll trigger an initial search if initial parameters contain
    // a search term or filters, or if alwaysSearchOnInitialLoad is set.
    // Otherwise, we'll just save their selections in state as initial values.

    if (_searchParameters.searchTerm || _searchParameters.filters.length > 0 || this.alwaysSearchOnInitialLoad) {
      this._updateSearchResults(_searchParameters, {
        replaceUrl: true
      });
    }
  }
  /**
   * This method is used to update state and trigger a new autocomplete search.
   *
   * @param {string} searchTerm
   * @param {Object=} Object
   * @param {boolean|Object} options.autocompleteResults - Should autocomplete results
   * @param {boolean|Object} options.autocompleteSuggestions - Should autocomplete suggestions
   */


  (0, _createClass2.default)(SearchDriver, [{
    key: "_setState",
    value: function _setState(newState) {
      var state = _objectSpread({}, this.state, {}, newState); // eslint-disable-next-line no-console


      if (this.debug) console.log("Search UI: State Update", newState, state);
      this.state = state;
      this.subscriptions.forEach(function (subscription) {
        return subscription(state);
      });
    }
    /**
     * Any time state is updated in this Driver, the provided callback
     * will be executed with the updated state.
     *
     * @param onStateChange Function
     */

  }, {
    key: "subscribeToStateChanges",
    value: function subscribeToStateChanges(onStateChange) {
      this.subscriptions.push(onStateChange);
    }
    /**
     * @param onStateChange Function
     */

  }, {
    key: "unsubscribeToStateChanges",
    value: function unsubscribeToStateChanges(onStateChange) {
      this.subscriptions = this.subscriptions.filter(function (sub) {
        return sub !== onStateChange;
      });
    }
    /**
     * Remove all listeners
     */

  }, {
    key: "tearDown",
    value: function tearDown() {
      this.subscriptions = [];
      this.URLManager && this.URLManager.tearDown();
    }
    /**
     * Retrieves all available acitons
     *
     * @returns Object All actions
     */

  }, {
    key: "getActions",
    value: function getActions() {
      return this.actions;
    }
    /**
     * Retrieve current state. Typically used on app initialization. Subsequent
     * state updates should come through subscription.
     *
     * @returns Object Current state
     */

  }, {
    key: "getState",
    value: function getState() {
      // We return a copy of state here, because we want to ensure the state
      // inside of this object remains immutable.
      return _objectSpread({}, this.state);
    }
  }]);
  return SearchDriver;
}();

exports.default = SearchDriver;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9TZWFyY2hEcml2ZXIuanMiXSwibmFtZXMiOlsiZmlsdGVyU2VhcmNoUGFyYW1ldGVycyIsImN1cnJlbnQiLCJmaWx0ZXJzIiwicmVzdWx0c1BlclBhZ2UiLCJzZWFyY2hUZXJtIiwic29ydERpcmVjdGlvbiIsInNvcnRGaWVsZCIsIkRFRkFVTFRfU1RBVEUiLCJhdXRvY29tcGxldGVkUmVzdWx0cyIsImF1dG9jb21wbGV0ZWRSZXN1bHRzUmVxdWVzdElkIiwiYXV0b2NvbXBsZXRlZFN1Z2dlc3Rpb25zIiwiYXV0b2NvbXBsZXRlZFN1Z2dlc3Rpb25zUmVxdWVzdElkIiwiZXJyb3IiLCJpc0xvYWRpbmciLCJmYWNldHMiLCJyZXF1ZXN0SWQiLCJyZXN1bHRzIiwicmVzdWx0U2VhcmNoVGVybSIsInRvdGFsUGFnZXMiLCJ0b3RhbFJlc3VsdHMiLCJwYWdpbmdTdGFydCIsInBhZ2luZ0VuZCIsIndhc1NlYXJjaGVkIiwicmVtb3ZlQ29uZGl0aW9uYWxGYWNldHMiLCJjb25kaXRpb25hbEZhY2V0cyIsIk9iamVjdCIsImVudHJpZXMiLCJyZWR1Y2UiLCJhY2MiLCJmYWNldEtleSIsImZhY2V0IiwiU2VhcmNoRHJpdmVyIiwiYXBpQ29ubmVjdG9yIiwiYXV0b2NvbXBsZXRlUXVlcnkiLCJkZWJ1ZyIsImluaXRpYWxTdGF0ZSIsIm9uU2VhcmNoIiwib25BdXRvY29tcGxldGUiLCJvblJlc3VsdENsaWNrIiwib25BdXRvY29tcGxldGVSZXN1bHRDbGljayIsInNlYXJjaFF1ZXJ5IiwidHJhY2tVcmxTdGF0ZSIsInVybFB1c2hEZWJvdW5jZUxlbmd0aCIsImhhc0ExMXlOb3RpZmljYXRpb25zIiwiYTExeU5vdGlmaWNhdGlvbk1lc3NhZ2VzIiwiYWx3YXlzU2VhcmNoT25Jbml0aWFsTG9hZCIsImF1dG9jb21wbGV0ZVJlc3VsdHMiLCJhdXRvY29tcGxldGVTdWdnZXN0aW9ucyIsImF1dG9jb21wbGV0ZVJlcXVlc3RTZXF1ZW5jZXIiLCJuZXh0IiwicXVlcnlDb25maWciLCJzdWdnZXN0aW9ucyIsImV2ZW50cyIsImF1dG9jb21wbGV0ZSIsInRoZW4iLCJhdXRvY29tcGxldGVkIiwiaXNPbGRSZXF1ZXN0IiwiY29tcGxldGVkIiwiX3NldFN0YXRlIiwic2VhcmNoUGFyYW1ldGVycyIsInNraXBQdXNoVG9VcmwiLCJyZXBsYWNlVXJsIiwic3RhdGUiLCJkZWJvdW5jZU1hbmFnZXIiLCJjYW5jZWxCeU5hbWUiLCJfbWFrZVNlYXJjaFJlcXVlc3QiLCJEZWJvdW5jZU1hbmFnZXIiLCJkZWJvdW5jZSIsInNlYXJjaFJlcXVlc3RTZXF1ZW5jZXIiLCJyZXF1ZXN0U3RhdGUiLCJzZWFyY2giLCJyZXN1bHRTdGF0ZSIsInN0YXJ0IiwiZW5kIiwibWVzc2FnZUFyZ3MiLCJhY3Rpb25zIiwiYTExeU5vdGlmeSIsInJ1bldpdGhEZWJvdW5jZSIsIlVSTE1hbmFnZXIiLCJwdXNoU3RhdGVUb1VSTCIsImJpbmQiLCJtZXNzYWdlIiwiYWN0aW9uTmFtZSIsImFjdGlvbiIsImFzc2lnbiIsIkV2ZW50cyIsImNvbnNvbGUiLCJ3YXJuIiwid2luZG93Iiwic2VhcmNoVUkiLCJSZXF1ZXN0U2VxdWVuY2VyIiwic3Vic2NyaXB0aW9ucyIsInVybFN0YXRlIiwiZ2V0U3RhdGVGcm9tVVJMIiwib25VUkxTdGF0ZUNoYW5nZSIsIl91cGRhdGVTZWFyY2hSZXN1bHRzIiwiYTExeSIsImdldExpdmVSZWdpb24iLCJkZWZhdWx0TWVzc2FnZXMiLCJzdGFydGluZ1N0YXRlIiwibGVuZ3RoIiwibmV3U3RhdGUiLCJsb2ciLCJmb3JFYWNoIiwic3Vic2NyaXB0aW9uIiwib25TdGF0ZUNoYW5nZSIsInB1c2giLCJmaWx0ZXIiLCJzdWIiLCJ0ZWFyRG93biJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUFBOztBQUVBOztBQUNBOztBQUVBOztBQUNBOztBQUVBOzs7Ozs7QUFFQSxTQUFTQSxzQkFBVCxPQU9HO0FBQUEsTUFOREMsT0FNQyxRQU5EQSxPQU1DO0FBQUEsTUFMREMs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LEdBQUcsS0FBS0gsYUFBWjtBQUFBLE9BRGdCLENBQXJCO0FBR0Q7QUFFRDs7Ozs7OytCQUdXO0FBQ1QsV0FBS2QsYUFBTCxHQUFxQixFQUFyQjtBQUNBLFdBQUtiLFVBQUwsSUFBbUIsS0FBS0EsVUFBTCxDQUFnQitCLFFBQWhCLEVBQW5CO0FBQ0Q7QUFFRDs7Ozs7Ozs7aUNBS2E7QUFDWCxhQUFPLEtBQUtsQyxPQUFaO0FBQ0Q7QUFFRDs7Ozs7Ozs7OytCQU1XO0FBQ1Q7QUFDQTtBQUNBLCtCQUFZLEtBQUtiLEtBQWpCO0FBQ0QiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgVVJMTWFuYWdlciBmcm9tIFwiLi9VUkxNYW5hZ2VyXCI7XG5cbmltcG9ydCBSZXF1ZXN0U2VxdWVuY2VyIGZyb20gXCIuL1JlcXVlc3RTZXF1ZW5jZXJcIjtcbmltcG9ydCBEZWJvdW5jZU1hbmFnZXIgZnJvbSBcIi4vRGVib3VuY2VNYW5hZ2VyXCI7XG5cbmltcG9ydCAqIGFzIGFjdGlvbnMgZnJvbSBcIi4vYWN0aW9uc1wiO1xuaW1wb3J0IEV2ZW50cyBmcm9tIFwiLi9FdmVudHNcIjtcblxuaW1wb3J0ICogYXMgYTExeSBmcm9tIFwiLi9BMTF5Tm90aWZpY2F0aW9uc1wiO1xuXG5mdW5jdGlvbiBmaWx0ZXJTZWFyY2hQYXJhbWV0ZXJzKHtcbiAgY3VycmVudCxcbiAgZmlsdGVycyxcbiAgcmVzdWx0c1BlclBhZ2UsXG4gIHNlYXJjaFRlcm0sXG4gIHNvcnREaXJlY3Rpb24sXG4gIHNvcnRGaWVsZFxufSkge1xuICByZXR1cm4ge1xuICAgIGN1cnJlbnQsXG4gICAgZmlsdGVycyxcbiAgICByZXN1bHRzUGVyUGFnZSxcbiAgICBzZWFyY2hUZXJtLFxuICAgIHNvcnREaXJlY3Rpb24sXG4gICAgc29ydEZpZWxkXG4gIH07XG59XG5cbmV4cG9ydCBjb25zdCBERUZBVUxUX1NUQVRFID0ge1xuICAvLyBTZWFyY2ggUGFyYW1ldGVycyAtLSBUaGlzIGlzIHN0YXRlIHRoYXQgcmVwcmVzZW50cyB0aGUgaW5wdXQgc3RhdGUuXG4gIGN1cnJlbnQ6IDEsXG4gIGZpbHRlcnM6IFtdLFxuICByZXN1bHRzUGVyUGFnZTogMjAsXG4gIHNlYXJjaFRlcm06IFwiXCIsXG4gIHNvcnREaXJlY3Rpb246IFwiXCIsXG4gIHNvcnRGaWVsZDogXCJcIixcbiAgLy8gUmVzdWx0IFN0YXRlIC0tIFRoaXMgc3RhdGUgcmVwcmVzZW50cyBzdGF0ZSB0aGF0IGlzIHVwZGF0ZWQgYXV0b21hdGljYWxseVxuICAvLyBhcyB0aGUgcmVzdWx0IG9mIGNoYW5naW5nIGlucHV0IHN0YXRlLlxuICBhdXRvY29tcGxldGVkUmVzdWx0czogW10sXG4gIGF1dG9jb21wbGV0ZWRSZXN1bHRzUmVxdWVzdElkOiBcIlwiLFxuICBhdXRvY29tcGxldGVkU3VnZ2VzdGlvbnM6IHt9LFxuICBhdXRvY29tcGxldGVkU3VnZ2VzdGlvbnNSZXF1ZXN0SWQ6IFwiXCIsXG4gIGVycm9yOiBcIlwiLFxuICBpc0xvYWRpbmc6IGZhbHNlLFxuICBmYWNldHM6IHt9LFxuICByZXF1ZXN0SWQ6IFwiXCIsXG4gIHJlc3VsdHM6IFtdLFxuICByZXN1bHRTZWFyY2hUZXJtOiBcIlwiLFxuICB0b3RhbFBhZ2VzOiAwLFxuICB0b3RhbFJlc3VsdHM6IDAsXG4gIHBhZ2luZ1N0YXJ0OiAwLFxuICBwYWdpbmdFbmQ6IDAsXG4gIHdhc1NlYXJjaGVkOiBmYWxzZVxufTtcblxuZnVuY3Rpb24gcmVtb3ZlQ29uZGl0aW9uYWxGYWNldHMoXG4gIGZhY2V0cyA9IHt9LFxuICBjb25kaXRpb25hbEZhY2V0cyA9IHt9LFxuICBmaWx0ZXJzID0gW11cbikge1xuICByZXR1cm4gT2JqZWN0LmVudHJpZXMoZmFjZXRzKS5yZWR1Y2UoKGFjYywgW2ZhY2V0S2V5LCBmYWNldF0pID0+IHtcbiAgICBpZiAoXG4gICAgICBjb25kaXRpb25hbEZhY2V0c1tmYWNldEtleV0gJiZcbiAgICAgIHR5cGVvZiBjb25kaXRpb25hbEZhY2V0c1tmYWNldEtleV0gPT09IFwiZnVuY3Rpb25cIiAmJlxuICAgICAgIWNvbmRpdGlvbmFsRmFjZXRzW2ZhY2V0S2V5XSh7IGZpbHRlcnMgfSlcbiAgICApIHtcbiAgICAgIHJldHVybiBhY2M7XG4gICAgfVxuXG4gICAgYWNjW2ZhY2V0S2V5XSA9IGZhY2V0O1xuICAgIHJldHVybiBhY2M7XG4gIH0sIHt9KTtcbn1cblxuLypcbiAqIFRoZSBEcml2ZXIgaXMgYSBmcmFtZXdvcmsgYWdub3N0aWMgc2VhcmNoIHN0YXRlIG1hbmFnZXIgdGhhdCBpcyBjYXBhYmxlXG4gKiBzeW5jaW5nIHN0YXRlIHRvIHRoZSB1cmwuXG4gKi9cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIFNlYXJjaERyaXZlciB7XG4gIHN0YXRlID0gREVGQVVMVF9TVEFURTtcblxuICBjb25zdHJ1Y3Rvcih7XG4gICAgYXBpQ29ubmVjdG9yLFxuICAgIGF1dG9jb21wbGV0ZVF1ZXJ5ID0ge30sXG4gICAgZGVidWcsXG4gICAgaW5pdGlhbFN0YXRlLFxuICAgIG9uU2VhcmNoLFxuICAgIG9uQXV0b2NvbXBsZXRlLFxuICAgIG9uUmVzdWx0Q2xpY2ssXG4gICAgb25BdXRvY29tcGxldGVSZXN1bHRDbGljayxcbiAgICBzZWFyY2hRdWVyeSA9IHt9LFxuICAgIHRyYWNrVXJsU3RhdGUgPSB0cnVlLFxuICAgIHVybFB1c2hEZWJvdW5jZUxlbmd0aCA9IDUwMCxcbiAgICBoYXNBMTF5Tm90aWZpY2F0aW9ucyA9IGZhbHNlLFxuICAgIGExMXlOb3RpZmljYXRpb25NZXNzYWdlcyA9IHt9LFxuICAgIGFsd2F5c1NlYXJjaE9uSW5pdGlhbExvYWQgPSBmYWxzZVxuICB9KSB7XG4gICAgdGhpcy5hY3Rpb25zID0gT2JqZWN0LmVudHJpZXMoYWN0aW9ucykucmVkdWNlKFxuICAgICAgKGFjYywgW2FjdGlvbk5hbWUsIGFjdGlvbl0pID0+IHtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAuLi5hY2MsXG4gICAgICAgICAgW2FjdGlvbk5hbWVdOiBhY3Rpb24uYmluZCh0aGlzKVxuICAgICAgICB9O1xuICAgICAgfSxcbiAgICAgIHt9XG4gICAgKTtcbiAgICBPYmplY3QuYXNzaWduKHRoaXMsIHRoaXMuYWN0aW9ucyk7XG5cbiAgICB0aGlzLmV2ZW50cyA9IG5ldyBFdmVudHMoe1xuICAgICAgYXBpQ29ubmVjdG9yLFxuICAgICAgb25TZWFyY2gsXG4gICAgICBvbkF1dG9jb21wbGV0ZSxcbiAgICAgIG9uUmVzdWx0Q2xpY2ssXG4gICAgICBvbkF1dG9jb21wbGV0ZVJlc3VsdENsaWNrXG4gICAgfSk7XG5cbiAgICB0aGlzLmRlYnVnID0gZGVidWc7XG4gICAgaWYgKHRoaXMuZGVidWcpIHtcbiAgICAgIGNvbnNvbGUud2FybihcbiAgICAgICAgXCJTZWFyY2ggVUkgRGVidWdnaW5nIGlzIGVuYWJsZWQuIFRoaXMgc2hvdWxkIGJlIHR1cm5lZCBvZmYgaW4gcHJvZHVjdGlvbiBkZXBsb3ltZW50cy5cIlxuICAgICAgKTtcbiAgICAgIHdpbmRvdy5zZWFyY2hVSSA9IHRoaXM7XG4gICAgfVxuICAgIHRoaXMuYXV0b2NvbXBsZXRlUmVxdWVzdFNlcXVlbmNlciA9IG5ldyBSZXF1ZXN0U2VxdWVuY2VyKCk7XG4gICAgdGhpcy5zZWFyY2hSZXF1ZXN0U2VxdWVuY2VyID0gbmV3IFJlcXVlc3RTZXF1ZW5jZXIoKTtcbiAgICB0aGlzLmRlYm91bmNlTWFuYWdlciA9IG5ldyBEZWJvdW5jZU1hbmFnZXIoKTtcbiAgICB0aGlzLmF1dG9jb21wbGV0ZVF1ZXJ5ID0gYXV0b2NvbXBsZXRlUXVlcnk7XG4gICAgdGhpcy5zZWFyY2hRdWVyeSA9IHNlYXJjaFF1ZXJ5O1xuICAgIHRoaXMuc3Vic2NyaXB0aW9ucyA9IFtdO1xuICAgIHRoaXMudHJhY2tVcmxTdGF0ZSA9IHRyYWNrVXJsU3RhdGU7XG4gICAgdGhpcy51cmxQdXNoRGVib3VuY2VMZW5ndGggPSB1cmxQdXNoRGVib3VuY2VMZW5ndGg7XG4gICAgdGhpcy5hbHdheXNTZWFyY2hPbkluaXRpYWxMb2FkID0gYWx3YXlzU2VhcmNoT25Jbml0aWFsTG9hZDtcblxuICAgIGxldCB1cmxTdGF0ZTtcbiAgICBpZiAodHJhY2tVcmxTdGF0ZSkge1xuICAgICAgdGhpcy5VUkxNYW5hZ2VyID0gbmV3IFVSTE1hbmFnZXIoKTtcbiAgICAgIHVybFN0YXRlID0gdGhpcy5VUkxNYW5hZ2VyLmdldFN0YXRlRnJvbVVSTCgpO1xuICAgICAgdGhpcy5VUkxNYW5hZ2VyLm9uVVJMU3RhdGVDaGFuZ2UodXJsU3RhdGUgPT4ge1xuICAgICAgICB0aGlzLl91cGRhdGVTZWFyY2hSZXN1bHRzKFxuICAgICAgICAgIHsgLi4uREVGQVVMVF9TVEFURSwgLi4udXJsU3RhdGUgfSxcbiAgICAgICAgICB7IHNraXBQdXNoVG9Vcmw6IHRydWUgfVxuICAgICAgICApO1xuICAgICAgfSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHVybFN0YXRlID0ge307XG4gICAgfVxuXG4gICAgLy8gTWFuYWdlIHNjcmVlbiByZWFkZXIgYWNjZXNzaWJsZSBub3RpZmljYXRpb25zXG4gICAgdGhpcy5oYXNBMTF5Tm90aWZpY2F0aW9ucyA9IGhhc0ExMXlOb3RpZmljYXRpb25zO1xuICAgIGlmICh0aGlzLmhhc0ExMXlOb3RpZmljYXRpb25zKSBhMTF5LmdldExpdmVSZWdpb24oKTtcblxuICAgIHRoaXMuYTExeU5vdGlmaWNhdGlvbk1lc3NhZ2VzID0ge1xuICAgICAgLi4uYTExeS5kZWZhdWx0TWVzc2FnZXMsXG4gICAgICAuLi5hMTF5Tm90aWZpY2F0aW9uTWVzc2FnZXNcbiAgICB9O1xuXG4gICAgLy8gUmVtZW1iZXIgdGhlIHN0YXRlIHRoaXMgYXBwbGljYXRpb24gaXMgaW5pdGlhbGl6ZWQgaW50bywgc28gdGhhdCB3ZSBjYW5cbiAgICAvLyByZXNldCB0byBpdCBsYXRlci5cbiAgICB0aGlzLnN0YXJ0aW5nU3RhdGUgPSB7XG4gICAgICAuLi50aGlzLnN0YXRlLFxuICAgICAgLi4uaW5pdGlhbFN0YXRlXG4gICAgfTtcblxuICAgIC8vIFdlIGZpbHRlciB0aGVzZSBoZXJlIHRvIGRpc2FsbG93IGFueXRoaW5nIG90aGVyIHRoYW4gdmFsaWQgc2VhcmNoXG4gICAgLy8gcGFyYW1ldGVycyB0byBiZSBwYXNzZWQgaW4gaW5pdGlhbCBzdGF0ZSwgb3IgdXJsIHN0YXRlLiBgcmVzdWx0c2AsIGV0YyxcbiAgICAvLyBzaG91bGQgbm90IGJlIGFsbG93ZWQgdG8gYmUgcGFzc2VkIGluLCB0aGF0IHNob3VsZCBiZSBnZW5lcmF0ZWQgYmFzZWQgb25cbiAgICAvLyB0aGUgcmVzdWx0cyBvZiB0aGUgcXVlcnlcbiAgICBjb25zdCBzZWFyY2hQYXJhbWV0ZXJzID0gZmlsdGVyU2VhcmNoUGFyYW1ldGVycyh7XG4gICAgICAuLi50aGlzLnN0YXJ0aW5nU3RhdGUsXG4gICAgICAuLi51cmxTdGF0ZVxuICAgIH0pO1xuXG4gICAgLy8gSW5pdGlhbGl6ZSB0aGUgc3RhdGUgd2l0aG91dCBjYWxsaW5nIF9zZXRTdGF0ZSwgYmVjYXVzZSB3ZSBkb24ndFxuICAgIC8vIHdhbnQgdG8gdHJpZ2dlciBhbiB1cGRhdGUgY2FsbGJhY2ssIHdlJ3JlIGp1c3QgaW5pdGlhbGl6aW5nIHRoZSBzdGF0ZVxuICAgIC8vIHRvIHRoZSBjb3JyZWN0IGRlZmF1bHQgdmFsdWVzIGZvciB0aGUgaW5pdGlhbCBVSSByZW5kZXJcbiAgICB0aGlzLnN0YXRlID0ge1xuICAgICAgLi4udGhpcy5zdGF0ZSxcbiAgICAgIC4uLnNlYXJjaFBhcmFtZXRlcnNcbiAgICB9O1xuXG4gICAgLy8gV2UnbGwgdHJpZ2dlciBhbiBpbml0aWFsIHNlYXJjaCBpZiBpbml0aWFsIHBhcmFtZXRlcnMgY29udGFpblxuICAgIC8vIGEgc2VhcmNoIHRlcm0gb3IgZmlsdGVycywgb3IgaWYgYWx3YXlzU2VhcmNoT25Jbml0aWFsTG9hZCBpcyBzZXQuXG4gICAgLy8gT3RoZXJ3aXNlLCB3ZSdsbCBqdXN0IHNhdmUgdGhlaXIgc2VsZWN0aW9ucyBpbiBzdGF0ZSBhcyBpbml0aWFsIHZhbHVlcy5cbiAgICBpZiAoXG4gICAgICBzZWFyY2hQYXJhbWV0ZXJzLnNlYXJjaFRlcm0gfHxcbiAgICAgIHNlYXJjaFBhcmFtZXRlcnMuZmlsdGVycy5sZW5ndGggPiAwIHx8XG4gICAgICB0aGlzLmFsd2F5c1NlYXJjaE9uSW5pdGlhbExvYWRcbiAgICApIHtcbiAgICAgIHRoaXMuX3VwZGF0ZVNlYXJjaFJlc3VsdHMoc2VhcmNoUGFyYW1ldGVycywgeyByZXBsYWNlVXJsOiB0cnVlIH0pO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBUaGlzIG1ldGhvZCBpcyB1c2VkIHRvIHVwZGF0ZSBzdGF0ZSBhbmQgdHJpZ2dlciBhIG5ldyBhdXRvY29tcGxldGUgc2VhcmNoLlxuICAgKlxuICAgKiBAcGFyYW0ge3N0cmluZ30gc2VhcmNoVGVybVxuICAgKiBAcGFyYW0ge09iamVjdD19IE9iamVjdFxuICAgKiBAcGFyYW0ge2Jvb2xlYW58T2JqZWN0fSBvcHRpb25zLmF1dG9jb21wbGV0ZVJlc3VsdHMgLSBTaG91bGQgYXV0b2NvbXBsZXRlIHJlc3VsdHNcbiAgICogQHBhcmFtIHtib29sZWFufE9iamVjdH0gb3B0aW9ucy5hdXRvY29tcGxldGVTdWdnZXN0aW9ucyAtIFNob3VsZCBhdXRvY29tcGxldGUgc3VnZ2VzdGlvbnNcbiAgICovXG4gIF91cGRhdGVBdXRvY29tcGxldGUgPSAoXG4gICAgc2VhcmNoVGVybSxcbiAgICB7IGF1dG9jb21wbGV0ZVJlc3VsdHMsIGF1dG9jb21wbGV0ZVN1Z2dlc3Rpb25zIH0gPSB7fVxuICApID0+IHtcbiAgICBjb25zdCByZXF1ZXN0SWQgPSB0aGlzLmF1dG9jb21wbGV0ZVJlcXVlc3RTZXF1ZW5jZXIubmV4dCgpO1xuXG4gICAgY29uc3QgcXVlcnlDb25maWcgPSB7XG4gICAgICAuLi4oYXV0b2NvbXBsZXRlUmVzdWx0cyAmJiB7XG4gICAgICAgIHJlc3VsdHM6IHRoaXMuYXV0b2NvbXBsZXRlUXVlcnkucmVzdWx0cyB8fCB7fVxuICAgICAgfSksXG4gICAgICAuLi4oYXV0b2NvbXBsZXRlU3VnZ2VzdGlvbnMgJiYge1xuICAgICAgICBzdWdnZXN0aW9uczogdGhpcy5hdXRvY29tcGxldGVRdWVyeS5zdWdnZXN0aW9ucyB8fCB7fVxuICAgICAgfSlcbiAgICB9O1xuXG4gICAgcmV0dXJuIHRoaXMuZXZlbnRzXG4gICAgICAuYXV0b2NvbXBsZXRlKHsgc2VhcmNoVGVybSB9LCBxdWVyeUNvbmZpZylcbiAgICAgIC50aGVuKGF1dG9jb21wbGV0ZWQgPT4ge1xuICAgICAgICBpZiAodGhpcy5hdXRvY29tcGxldGVSZXF1ZXN0U2VxdWVuY2VyLmlzT2xkUmVxdWVzdChyZXF1ZXN0SWQpKSByZXR1cm47XG4gICAgICAgIHRoaXMuYXV0b2NvbXBsZXRlUmVxdWVzdFNlcXVlbmNlci5jb21wbGV0ZWQocmVxdWVzdElkKTtcblxuICAgICAgICB0aGlzLl9zZXRTdGF0ZShhdXRvY29tcGxldGVkKTtcbiAgICAgIH0pO1xuICB9O1xuXG4gIC8qKlxuICAgKiBUaGlzIG1ldGhvZCBpcyB1c2VkIHRvIHVwZGF0ZSBzdGF0ZSBhbmQgdHJpZ2dlciBhIG5ldyBzZWFyY2guXG4gICAqXG4gICAqIEB0eXBlZGVmIHtPYmplY3R9IFJlcXVlc3RTdGF0ZVxuICAgKiBAcHJvcGVydHkge251bWJlcn0gY3VycmVudFxuICAgKiBAcHJvcGVydHkge251bWJlcn0gcmVzdWx0c1BlclBhZ2VcbiAgICogQHByb3BlcnR5IHtzdHJpbmd9IHNlYXJjaFRlcm1cbiAgICogQHByb3BlcnR5IHtzdHJpbmd9IHNvcnREaXJlY3Rpb25cbiAgICogQHByb3BlcnR5IHtzdHJpbmd9IHNvcnRGaWVsZFxuICAgKlxuICAgKiBAcGFyYW0ge1JlcXVlc3RTdGF0ZX0gc2VhcmNoUGFyYW1ldGVycyAtIFJlcXVlc3RTdGF0ZVxuICAgKiBAcGFyYW0ge09iamVjdD19IE9iamVjdFxuICAgKiBAcGFyYW0ge2Jvb2xlYW59IG9wdGlvbnMuc2tpcFB1c2hUb1VybCAtIFNraXAgcHVzaGluZyB0aGUgdXBkYXRlZCB0byB0aGUgVVJMXG4gICAqIEBwYXJhbSB7Ym9vbGVhbn0gb3B0aW9ucy5yZXBsYWNlVXJsIC0gV2hlbiBwdXNoaW5nIHN0YXRlIHRvIHRoZSBVUkwsIHVzZSBoaXN0b3J5ICdyZXBsYWNlJ1xuICAgKiByYXRoZXIgdGhhbiAncHVzaCcgdG8gYXZvaWQgYWRkaW5nIGEgbmV3IGhpc3RvcnkgZW50cnlcbiAgICovXG4gIF91cGRhdGVTZWFyY2hSZXN1bHRzID0gKFxuICAgIHNlYXJjaFBhcmFtZXRlcnMsXG4gICAgeyBza2lwUHVzaFRvVXJsID0gZmFsc2UsIHJlcGxhY2VVcmwgPSBmYWxzZSB9ID0ge31cbiAgKSA9PiB7XG4gICAgY29uc3Qge1xuICAgICAgY3VycmVudCxcbiAgICAgIGZpbHRlcnMsXG4gICAgICByZXN1bHRzUGVyUGFnZSxcbiAgICAgIHNlYXJjaFRlcm0sXG4gICAgICBzb3J0RGlyZWN0aW9uLFxuICAgICAgc29ydEZpZWxkXG4gICAgfSA9IHtcbiAgICAgIC4uLnRoaXMuc3RhdGUsXG4gICAgICAuLi5zZWFyY2hQYXJhbWV0ZXJzXG4gICAgfTtcblxuICAgIC8vIFN0YXRlIHVwZGF0ZXMgc2hvdWxkIGFsd2F5cyBiZSBhcHBsaWVkIGluIHRoZSBvcmRlciB0aGF0IHRoZXkgYXJlIG1hZGUuIFRoaXMgZnVuY3Rpb24sIF91cGRhdGVTZWFyY2hSZXN1bHRzLFxuICAgIC8vIG1ha2VzIHN0YXRlIHVwZGF0ZXMuXG4gICAgLy8gSW4gdGhlIGNhc2Ugd2hlcmUgYSBjYWxsIHRvIFwiX3VwZGF0ZVNlYXJjaFJlc3VsdHNcIiB3YXMgbWFkZSBhbmQgZGVsYXllZCBmb3IgWCBhbW91bnQgb2YgdGltZSB1c2luZ1xuICAgIC8vIGBkZWJvdW5jZU1hbmFnZXIucnVuV2l0aERlYm91bmNlYCwgYW5kIGEgc3Vic2VxdWVudCBjYWxsIGlzIG1hZGUgX3VwZGF0ZVNlYXJjaFJlc3VsdHMgYmVmb3JlIHRoYXQgZGVsYXkgZW5kcywgd2VcbiAgICAvLyB3YW50IHRvIG1ha2Ugc3VyZSB0aGF0IG91dHN0YW5kaW5nIGNhbGwgdG8gXCJfdXBkYXRlU2VhcmNoUmVzdWx0c1wiIGlzIGNhbmNlbGxlZCwgYXMgaXQgd291bGQgYXBwbHkgc3RhdGUgdXBkYXRlc1xuICAgIC8vIG91dCBvZiBvcmRlci5cbiAgICB0aGlzLmRlYm91bmNlTWFuYWdlci5jYW5jZWxCeU5hbWUoXCJfdXBkYXRlU2VhcmNoUmVzdWx0c1wiKTtcblxuICAgIHRoaXMuX3NldFN0YXRlKHtcbiAgICAgIGN1cnJlbnQsXG4gICAgICBlcnJvcjogXCJcIixcbiAgICAgIGZpbHRlcnMsXG4gICAgICByZXN1bHRzUGVyUGFnZSxcbiAgICAgIHNlYXJjaFRlcm0sXG4gICAgICBzb3J0RGlyZWN0aW9uLFxuICAgICAgc29ydEZpZWxkXG4gICAgfSk7XG5cbiAgICB0aGlzLl9tYWtlU2VhcmNoUmVxdWVzdCh7XG4gICAgICBza2lwUHVzaFRvVXJsLFxuICAgICAgcmVwbGFjZVVybFxuICAgIH0pO1xuICB9O1xuXG4gIC8qKlxuICAgKiBUaGlzIG1ldGhvZCBpcyBzZXBhcmF0ZWQgb3V0IGZyb20gX3VwZGF0ZVNlYXJjaFJlc3VsdHMgc28gdGhhdCBpdFxuICAgKiBjYW4gYmUgZGVib3VuY2VkLlxuICAgKlxuICAgKiBCeSBkZWJvdW5jaW5nIG91ciBBUEkgY2FsbHMsIHdlIGNhbiBlZmZlY3RpdmVseSBhbGxvdyBhY3Rpb24gY2hhaW5pbmcuXG4gICAqXG4gICAqIEZvciBFeDpcbiAgICpcbiAgICogSWYgYSB1c2VyIG5lZWRzIHRvIG1ha2UgbXVsdGlwbGUgZmlsdGVyIHVwZGF0ZXMgYXQgb25jZSwgdGhleSBjb3VsZFxuICAgKiBkbyBzbyBieSBjYWxsaW5nIGFuIGFjdGlvbiAzIHRpbWVzIGluIGEgcm93OlxuICAgKlxuICAgKiAgIGFkZEZpbHRlcihcInN0YXRlc1wiLCBcIkNhbGlmb3JuaWFcIik7XG4gICAqICAgYWRkRmlsdGVyKFwic3RhdGVzXCIsIFwiTmVicmFza2FcIik7XG4gICAqICAgYWRkRmlsdGVyKFwic3RhdGVzXCIsIFwiUGVubnN5bHZhbmlhXCIpO1xuICAgKlxuICAgKiBXZSBkb24ndCB3YW50IHRvIG1ha2UgMyBzZXBhcmF0ZSBBUEkgY2FsbHMgbGlrZSB0aGF0IGluIHF1aWNrIHN1Y2Nlc3Npb24sXG4gICAqIHNvIHdlIGRlYm91bmNlIHRoZSBBUEkgY2FsbHMuXG4gICAqXG4gICAqIEFwcGxpY2F0aW9uIHN0YXRlIHVwZGF0ZXMgYXJlIHBlcmZvcm1lZCBpbiBfdXBkYXRlU2VhcmNoUmVzdWx0cywgYnV0IHdlXG4gICAqIHdhaXQgdG8gbWFrZSB0aGUgYWN0dWFsIEFQSSBjYWxscyB1bnRpbCBhbGwgYWN0aW9ucyBoYXZlIGJlZW4gY2FsbGVkLlxuICAgKlxuICAgKiBAcGFyYW0ge09iamVjdH0gb3B0aW9uc1xuICAgKiBAcGFyYW0ge2Jvb2xlYW59IG9wdGlvbnMuc2tpcFB1c2hUb1VybCAtIFNraXAgcHVzaGluZyB0aGUgdXBkYXRlZCB0byB0aGUgVVJMXG4gICAqIEBwYXJhbSB7Ym9vbGVhbn0gb3B0aW9ucy5yZXBsYWNlVXJsIC0gV2hlbiBwdXNoaW5nIHN0YXRlIHRvIHRoZSBVUkwsIHVzZSBoaXN0b3J5ICdyZXBsYWNlJ1xuICAgKiByYXRoZXIgdGhhbiAncHVzaCcgdG8gYXZvaWQgYWRkaW5nIGEgbmV3IGhpc3RvcnkgZW50cnlcbiAgICovXG4gIF9tYWtlU2VhcmNoUmVxdWVzdCA9IERlYm91bmNlTWFuYWdlci5kZWJvdW5jZShcbiAgICAwLFxuICAgICh7IHNraXBQdXNoVG9VcmwsIHJlcGxhY2VVcmwgfSkgPT4ge1xuICAgICAgY29uc3Qge1xuICAgICAgICBjdXJyZW50LFxuICAgICAgICBmaWx0ZXJzLFxuICAgICAgICByZXN1bHRzUGVyUGFnZSxcbiAgICAgICAgc2VhcmNoVGVybSxcbiAgICAgICAgc29ydERpcmVjdGlvbixcbiAgICAgICAgc29ydEZpZWxkXG4gICAgICB9ID0gdGhpcy5zdGF0ZTtcblxuICAgICAgdGhpcy5fc2V0U3RhdGUoe1xuICAgICAgICBpc0xvYWRpbmc6IHRydWVcbiAgICAgIH0pO1xuXG4gICAgICBjb25zdCByZXF1ZXN0SWQgPSB0aGlzLnNlYXJjaFJlcXVlc3RTZXF1ZW5jZXIubmV4dCgpO1xuXG4gICAgICBjb25zdCBxdWVyeUNvbmZpZyA9IHtcbiAgICAgICAgLi4udGhpcy5zZWFyY2hRdWVyeSxcbiAgICAgICAgZmFjZXRzOiByZW1vdmVDb25kaXRpb25hbEZhY2V0cyhcbiAgICAgICAgICB0aGlzLnNlYXJjaFF1ZXJ5LmZhY2V0cyxcbiAgICAgICAgICB0aGlzLnNlYXJjaFF1ZXJ5LmNvbmRpdGlvbmFsRmFjZXRzLFxuICAgICAgICAgIGZpbHRlcnNcbiAgICAgICAgKVxuICAgICAgfTtcblxuICAgICAgY29uc3QgcmVxdWVzdFN0YXRlID0gZmlsdGVyU2VhcmNoUGFyYW1ldGVycyh0aGlzLnN0YXRlKTtcblxuICAgICAgcmV0dXJuIHRoaXMuZXZlbnRzLnNlYXJjaChyZXF1ZXN0U3RhdGUsIHF1ZXJ5Q29uZmlnKS50aGVuKFxuICAgICAgICByZXN1bHRTdGF0ZSA9PiB7XG4gICAgICAgICAgaWYgKHRoaXMuc2VhcmNoUmVxdWVzdFNlcXVlbmNlci5pc09sZFJlcXVlc3QocmVxdWVzdElkKSkgcmV0dXJuO1xuICAgICAgICAgIHRoaXMuc2VhcmNoUmVxdWVzdFNlcXVlbmNlci5jb21wbGV0ZWQocmVxdWVzdElkKTtcblxuICAgICAgICAgIC8vIFJlc3VsdHMgcGFnaW5nIHN0YXJ0ICYgZW5kXG4gICAgICAgICAgY29uc3QgeyB0b3RhbFJlc3VsdHMgfSA9IHJlc3VsdFN0YXRlO1xuICAgICAgICAgIGNvbnN0IHN0YXJ0ID1cbiAgICAgICAgICAgIHRvdGFsUmVzdWx0cyA9PT0gMCA/IDAgOiAoY3VycmVudCAtIDEpICogcmVzdWx0c1BlclBhZ2UgKyAxO1xuICAgICAgICAgIGNvbnN0IGVuZCA9XG4gICAgICAgICAgICB0b3RhbFJlc3VsdHMgPD0gc3RhcnQgKyByZXN1bHRzUGVyUGFnZVxuICAgICAgICAgICAgICA/IHRvdGFsUmVzdWx0c1xuICAgICAgICAgICAgICA6IHN0YXJ0ICsgcmVzdWx0c1BlclBhZ2UgLSAxO1xuXG4gICAgICAgICAgdGhpcy5fc2V0U3RhdGUoe1xuICAgICAgICAgICAgaXNMb2FkaW5nOiBmYWxzZSxcbiAgICAgICAgICAgIHJlc3VsdFNlYXJjaFRlcm06IHNlYXJjaFRlcm0sXG4gICAgICAgICAgICBwYWdpbmdTdGFydDogc3RhcnQsXG4gICAgICAgICAgICBwYWdpbmdFbmQ6IGVuZCxcbiAgICAgICAgICAgIC4uLnJlc3VsdFN0YXRlLFxuICAgICAgICAgICAgd2FzU2VhcmNoZWQ6IHRydWVcbiAgICAgICAgICB9KTtcblxuICAgICAgICAgIGlmICh0aGlzLmhhc0ExMXlOb3RpZmljYXRpb25zKSB7XG4gICAgICAgICAgICBjb25zdCBtZXNzYWdlQXJncyA9IHsgc3RhcnQsIGVuZCwgdG90YWxSZXN1bHRzLCBzZWFyY2hUZXJtIH07XG4gICAgICAgICAgICB0aGlzLmFjdGlvbnMuYTExeU5vdGlmeShcInNlYXJjaFJlc3VsdHNcIiwgbWVzc2FnZUFyZ3MpO1xuICAgICAgICAgIH1cblxuICAgICAgICAgIGlmICghc2tpcFB1c2hUb1VybCAmJiB0aGlzLnRyYWNrVXJsU3RhdGUpIHtcbiAgICAgICAgICAgIC8vIFdlIGRlYm91bmNlIGhlcmUgc28gdGhhdCB3ZSBkb24ndCBnZXQgYSBsb3Qgb2YgaW50ZXJtZWRpYXJ5XG4gICAgICAgICAgICAvLyBVUkwgc3RhdGUgaWYgc29tZW9uZSBpcyB1cGRhdGluZyBhIFVJIHJlYWxseSBmYXN0LCBsaWtlIHR5cGluZ1xuICAgICAgICAgICAgLy8gaW4gYSBsaXZlIHNlYXJjaCBib3ggZm9yIGluc3RhbmNlLlxuICAgICAgICAgICAgdGhpcy5kZWJvdW5jZU1hbmFnZXIucnVuV2l0aERlYm91bmNlKFxuICAgICAgICAgICAgICB0aGlzLnVybFB1c2hEZWJvdW5jZUxlbmd0aCxcbiAgICAgICAgICAgICAgXCJwdXNoU3RhdGVUb1VSTFwiLFxuICAgICAgICAgICAgICB0aGlzLlVSTE1hbmFnZXIucHVzaFN0YXRlVG9VUkwuYmluZCh0aGlzLlVSTE1hbmFnZXIpLFxuICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgY3VycmVudCxcbiAgICAgICAgICAgICAgICBmaWx0ZXJzLFxuICAgICAgICAgICAgICAgIHJlc3VsdHNQZXJQYWdlLFxuICAgICAgICAgICAgICAgIHNlYXJjaFRlcm0sXG4gICAgICAgICAgICAgICAgc29ydERpcmVjdGlvbixcbiAgICAgICAgICAgICAgICBzb3J0RmllbGRcbiAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgeyByZXBsYWNlVXJsIH1cbiAgICAgICAgICAgICk7XG4gICAgICAgICAgfVxuICAgICAgICB9LFxuICAgICAgICBlcnJvciA9PiB7XG4gICAgICAgICAgdGhpcy5fc2V0U3RhdGUoe1xuICAgICAgICAgICAgZXJyb3I6IGBBbiB1bmV4cGVjdGVkIGVycm9yIG9jY3VycmVkOiAke2Vycm9yLm1lc3NhZ2V9YFxuICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgICApO1xuICAgIH1cbiAgKTtcblxuICBfc2V0U3RhdGUobmV3U3RhdGUpIHtcbiAgICBjb25zdCBzdGF0ZSA9IHsgLi4udGhpcy5zdGF0ZSwgLi4ubmV3U3RhdGUgfTtcbiAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbm8tY29uc29sZVxuICAgIGlmICh0aGlzLmRlYnVnKSBjb25zb2xlLmxvZyhcIlNlYXJjaCBVSTogU3RhdGUgVXBkYXRlXCIsIG5ld1N0YXRlLCBzdGF0ZSk7XG4gICAgdGhpcy5zdGF0ZSA9IHN0YXRlO1xuICAgIHRoaXMuc3Vic2NyaXB0aW9ucy5mb3JFYWNoKHN1YnNjcmlwdGlvbiA9PiBzdWJzY3JpcHRpb24oc3RhdGUpKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBBbnkgdGltZSBzdGF0ZSBpcyB1cGRhdGVkIGluIHRoaXMgRHJpdmVyLCB0aGUgcHJvdmlkZWQgY2FsbGJhY2tcbiAgICogd2lsbCBiZSBleGVjdXRlZCB3aXRoIHRoZSB1cGRhdGVkIHN0YXRlLlxuICAgKlxuICAgKiBAcGFyYW0gb25TdGF0ZUNoYW5nZSBGdW5jdGlvblxuICAgKi9cbiAgc3Vic2NyaWJlVG9TdGF0ZUNoYW5nZXMob25TdGF0ZUNoYW5nZSkge1xuICAgIHRoaXMuc3Vic2NyaXB0aW9ucy5wdXNoKG9uU3RhdGVDaGFuZ2UpO1xuICB9XG5cbiAgLyoqXG4gICAqIEBwYXJhbSBvblN0YXRlQ2hhbmdlIEZ1bmN0aW9uXG4gICAqL1xuICB1bnN1YnNjcmliZVRvU3RhdGVDaGFuZ2VzKG9uU3RhdGVDaGFuZ2UpIHtcbiAgICB0aGlzLnN1YnNjcmlwdGlvbnMgPSB0aGlzLnN1YnNjcmlwdGlvbnMuZmlsdGVyKFxuICAgICAgc3ViID0+IHN1YiAhPT0gb25TdGF0ZUNoYW5nZVxuICAgICk7XG4gIH1cblxuICAvKipcbiAgICogUmVtb3ZlIGFsbCBsaXN0ZW5lcnNcbiAgICovXG4gIHRlYXJEb3duKCkge1xuICAgIHRoaXMuc3Vic2NyaXB0aW9ucyA9IFtdO1xuICAgIHRoaXMuVVJMTWFuYWdlciAmJiB0aGlzLlVSTE1hbmFnZXIudGVhckRvd24oKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZXRyaWV2ZXMgYWxsIGF2YWlsYWJsZSBhY2l0b25zXG4gICAqXG4gICAqIEByZXR1cm5zIE9iamVjdCBBbGwgYWN0aW9uc1xuICAgKi9cbiAgZ2V0QWN0aW9ucygpIHtcbiAgICByZXR1cm4gdGhpcy5hY3Rpb25zO1xuICB9XG5cbiAgLyoqXG4gICAqIFJldHJpZXZlIGN1cnJlbnQgc3RhdGUuIFR5cGljYWxseSB1c2VkIG9uIGFwcCBpbml0aWFsaXphdGlvbi4gU3Vic2VxdWVudFxuICAgKiBzdGF0ZSB1cGRhdGVzIHNob3VsZCBjb21lIHRocm91Z2ggc3Vic2NyaXB0aW9uLlxuICAgKlxuICAgKiBAcmV0dXJucyBPYmplY3QgQ3VycmVudCBzdGF0ZVxuICAgKi9cbiAgZ2V0U3RhdGUoKSB7XG4gICAgLy8gV2UgcmV0dXJuIGEgY29weSBvZiBzdGF0ZSBoZXJlLCBiZWNhdXNlIHdlIHdhbnQgdG8gZW5zdXJlIHRoZSBzdGF0ZVxuICAgIC8vIGluc2lkZSBvZiB0aGlzIG9iamVjdCByZW1haW5zIGltbXV0YWJsZS5cbiAgICByZXR1cm4geyAuLi50aGlzLnN0YXRlIH07XG4gIH1cbn1cbiJdfQ==